<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BFF Playground</title>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <style>
        body { background-color: #f8fafc; color: #334155; font-family: 'Inter', system-ui, sans-serif; } 
        .preview-box { background-color: #ffffff; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 20px 20px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); }
        .glass-header { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const BRIDGE_URL = "ws://localhost:8888";
        const TOKEN = "bff-alpha-token";

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        window.backendData = {};

        const EXAMPLES = {
            javascript: `// Node.js (Local)\nconst os = require('os');\nreturn { lang: "Node.js", platform: os.platform() };`,
            typescript: `// TypeScript (Cloud)\nconst msg: string = "Hello from TS";\nconsole.log(JSON.stringify({ msg }));`,
            python: `# Python 3 (Cloud)\nimport json\nprint(json.dumps({"lang": "Python"}))`,
            go: `package main\nimport ("encoding/json"; "fmt")\nfunc main() { fmt.Println("{\\\"lang\\\": \\\"Go\\\"}") }`,
            rust: `fn main() { println!("{{\\\"lang\\\": \\\"Rust\\\"}}"); }`,
            java: `public class Main { public static void main(String[] a) { System.out.println("{\\\"lang\\\": \\\"Java\\\"}"); } }`,
            csharp: `using System; class P { static void Main() { Console.WriteLine("{\\\"lang\\\": \\\"C#\\\"}"); } }`
        };

        function HelpModal({ isOpen, onClose }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center modal-overlay" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl m-4 overflow-hidden border border-slate-100 animate-[fadeIn_0.2s_ease-out]" onClick={e => e.stopPropagation()}>
                        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100 bg-slate-50/80">
                            <h3 className="font-bold text-xl text-slate-800">Documentation</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><i data-lucide="x" className="w-5 h-5"></i></button>
                        </div>
                        <div className="p-8 max-h-[70vh] overflow-y-auto text-slate-600">
                            <p className="mb-6 text-lg">Welcome to the <strong>Literate Full-Stack Playground</strong>.</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div className="bg-slate-50 p-5 rounded-xl border border-slate-200">
                                    <h4 className="font-bold text-slate-900 mb-3 flex items-center gap-2"><i data-lucide="terminal" className="w-4 h-4 text-purple-600"></i> Backend</h4>
                                    <ul className="space-y-2 text-sm">
                                        <li><strong className="text-slate-800">Node.js:</strong> Local execution. Full access to your file system.</li>
                                        <li><strong className="text-slate-800">!Shell:</strong> Start line with <code>!</code> to run terminal commands.</li>
                                        <li><strong className="text-slate-800">Cloud:</strong> Python, Go, Rust run remotely.</li>
                                    </ul>
                                </div>
                                <div className="bg-slate-50 p-5 rounded-xl border border-slate-200">
                                    <h4 className="font-bold text-slate-900 mb-3 flex items-center gap-2"><i data-lucide="layout" className="w-4 h-4 text-pink-600"></i> Frontend</h4>
                                    <ul className="space-y-2 text-sm">
                                        <li><strong className="text-slate-800">React:</strong> JSX compiled in-browser.</li>
                                        <li><strong className="text-slate-800">Binding:</strong> Use <code>window.backendData['cell_ID']</code> to access data.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Editor({ code, onChange, language }) {
            const containerRef = useRef(null);
            const editorRef = useRef(null);
            const getMonacoLang = (l) => {
                if (l === 'csharp') return 'csharp';
                if (l === 'java') return 'java';
                return l === 'javascript' ? 'javascript' : (l === 'go' ? 'go' : (l === 'rust' ? 'rust' : (l === 'php' ? 'php' : 'python')));
            }
            useEffect(() => {
                if (containerRef.current) {
                    require(['vs/editor/editor.main'], function () {
                        if (!containerRef.current) return;
                        editorRef.current = monaco.editor.create(containerRef.current, {
                            value: code, language: getMonacoLang(language), theme: 'vs', 
                            automaticLayout: true, minimap: { enabled: false }, fontSize: 13, 
                            fontFamily: "'Fira Code', Consolas, monospace", padding: { top: 16 }, renderLineHighlight: 'none', scrollBeyondLastLine: false
                        });
                        editorRef.current.onDidChangeModelContent(() => onChange(editorRef.current.getValue()));
                    });
                }
                return () => editorRef.current && editorRef.current.dispose();
            }, []);
            useEffect(() => {
                if (editorRef.current) {
                    const model = editorRef.current.getModel();
                    monaco.editor.setModelLanguage(model, getMonacoLang(language));
                    if (editorRef.current.getValue() !== code) editorRef.current.setValue(code);
                }
            }, [language]);
            return <div ref={containerRef} className="w-full h-full min-h-[200px]" />;
        }

        function App() {
            const [status, setStatus] = useState("disconnected");
            const [socket, setSocket] = useState(null);
            const [showHelp, setShowHelp] = useState(false);
            const [cells, setCells] = useState([{ id: 1, type: 'backend', language: 'javascript', filename: 'api.js', code: EXAMPLES.javascript, output: null, status: 'idle' }]);
            const cellsRef = useRef(cells);
            useEffect(() => { cellsRef.current = cells; }, [cells]);

            useEffect(() => {
                const ws = new WebSocket(BRIDGE_URL);
                ws.onopen = () => { setStatus("connected"); setSocket(ws); ws.send(JSON.stringify({ token: TOKEN, command: 'LOAD' })); };
                ws.onclose = () => setStatus("disconnected");
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'LOAD_DATA') { setCells(data.cells.map(c => ({...c, loadKey: Date.now()}))); setTimeout(() => data.cells.forEach(c => { if(c.type === 'frontend') executeCell(c.id); }), 500); }
                    else if (data.type === 'result') handleBackendResult(data.cellId, data.content);
                    else if (data.type === 'error') handleBackendError(data.cellId, data.content);
                };
                return () => ws.close();
            }, []);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [cells, showHelp]);

            const executeCellRef = useRef(null);
            const executeCell = (id) => {
                const cell = cellsRef.current.find(c => c.id === id);
                if(!cell) return;
                setCells(prev => prev.map(c => c.id === id ? { ...c, status: 'running', error: null } : c));
                if (cell.type === 'backend') { /* Handled by runCell */ } else {
                    setTimeout(() => {
                        try {
                            const wrappedCode = `(function(React, window) { ${cell.code} })`;
                            const transpiled = Babel.transform(wrappedCode, { presets: ['react'] }).code;
                            const renderFunction = eval(transpiled);
                            const resultComponent = renderFunction(React, window);
                            setCells(prev => prev.map(c => c.id === id ? { ...c, output: resultComponent, status: 'success' } : c));
                        } catch (err) {
                            setCells(prev => prev.map(c => c.id === id ? { ...c, error: err.message, status: 'error' } : c));
                        }
                    }, 10);
                }
            };
            executeCellRef.current = executeCell;

            const runCell = (id) => {
                const cell = cellsRef.current.find(c => c.id === id);
                if (cell.type === 'backend') {
                    setCells(prev => prev.map(c => c.id === id ? { ...c, status: 'running', error: null } : c));
                    if (socket && socket.readyState === 1) socket.send(JSON.stringify({ token: TOKEN, command: 'EXECUTE', cellId: id, code: cell.code, language: cell.language || 'javascript' }));
                } else executeCell(id);
            };

            const handleBackendResult = (cellId, content) => {
                window.backendData[`cell_${cellId}`] = content;
                setCells(prev => prev.map(c => c.id === cellId ? { ...c, output: JSON.stringify(content, null, 2), status: 'success', error: null } : c));
                const allCells = cellsRef.current;
                const dependents = allCells.filter(c => c.id !== cellId && (c.code.includes(`['cell_${cellId}']`) || c.code.includes(`["cell_${cellId}"]`)));
                dependents.forEach(dep => runCell(dep.id));
            };

            const handleBackendError = (cellId, errorMsg) => setCells(prev => prev.map(c => c.id === cellId ? { ...c, error: errorMsg, status: 'error' } : c));
            const saveProject = () => { if (socket) socket.send(JSON.stringify({ token: TOKEN, command: 'SAVE', cells: cellsRef.current.map(({output, error, status, loadKey, ...rest}) => ({...rest, output: null, status: 'idle'})) })); };
            const exportProject = () => { if (socket) socket.send(JSON.stringify({ token: TOKEN, command: 'EXPORT', cells: cellsRef.current })); };
            const clearOutput = (id) => { setCells(prev => prev.map(c => c.id === id ? { ...c, output: null, error: null, status: 'idle' } : c)); };
            
            const deleteCell = (id) => {
                if(confirm("Are you sure you want to delete this cell?")) {
                    setCells(prev => prev.filter(c => c.id !== id));
                }
            };

            const addCell = (type) => {
                const newId = cells.length > 0 ? Math.max(...cells.map(c => c.id)) + 1 : 1;
                setCells([...cells, { id: newId, type, language: 'javascript', filename: type === 'backend' ? `script_${newId}.js` : `Ui_${newId}.jsx`, code: EXAMPLES.javascript, output: null, status: 'idle' }]);
            };

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <header className="h-16 glass-header border-b border-slate-200/70 flex items-center justify-between px-8 sticky top-0 z-50 shadow-sm">
                         <div className="flex items-center gap-3">
                             <div className="bg-indigo-600 text-white p-1.5 rounded-lg shadow-lg shadow-indigo-200"><i data-lucide="zap" className="w-5 h-5 fill-current"></i></div>
                             <h1 className="text-xl font-extrabold text-slate-800 tracking-tight">BFF <span className="font-light text-slate-500">Playground</span></h1>
                         </div>
                         <div className="flex items-center gap-4">
                             <button onClick={() => setShowHelp(true)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors" title="Documentation"><i data-lucide="help-circle" className="w-6 h-6"></i></button>
                             <div className="h-6 w-px bg-slate-300"></div>
                             <button onClick={exportProject} className="flex items-center gap-2 px-4 py-2 bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 text-xs font-bold uppercase tracking-wider rounded-lg transition-all shadow-sm hover:shadow"><i data-lucide="download" className="w-4 h-4 text-indigo-500"></i> Export</button>
                             <button onClick={saveProject} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold uppercase tracking-wider rounded-lg transition-all shadow-md shadow-indigo-200 hover:shadow-lg hover:shadow-indigo-300"><i data-lucide="save" className="w-4 h-4"></i> Save</button>
                             <span className={`block w-3 h-3 rounded-full ${status === 'connected' ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-red-500'}`}></span>
                        </div>
                    </header>

                    <main className="flex-1 p-8 overflow-y-auto max-w-6xl mx-auto w-full space-y-8 pb-32">
                        {cells.map(cell => (
                            <Cell key={cell.id + (cell.loadKey || '')} cell={cell} 
                                onLangChange={(lang) => setCells(prev => prev.map(c => c.id === cell.id ? { ...c, language: lang, filename: `script_${c.id}.${lang === 'python' ? 'py' : lang === 'go' ? 'go' : lang === 'rust' ? 'rs' : lang === 'java' ? 'java' : 'js'}`, code: EXAMPLES[lang] || '' } : c))}
                                onFilenameChange={(val) => setCells(prev => prev.map(c => c.id === cell.id ? { ...c, filename: val } : c))}
                                onChange={(val) => setCells(prev => prev.map(c => c.id === cell.id ? { ...c, code: val } : c))} 
                                onRun={() => runCell(cell.id)}
                                onClear={() => clearOutput(cell.id)}
                                onDelete={() => deleteCell(cell.id)} />
                        ))}
                        
                        <div className="flex justify-center gap-6 py-8 opacity-80 hover:opacity-100 transition-opacity">
                            <button onClick={() => addCell('backend')} className="group flex items-center gap-3 px-6 py-3 bg-white hover:bg-slate-50 text-slate-600 text-sm font-bold border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all">
                                <span className="bg-purple-100 p-1.5 rounded text-purple-600 group-hover:bg-purple-200 transition-colors"><i data-lucide="server" className="w-4 h-4"></i></span> Add Backend
                            </button>
                            <button onClick={() => addCell('frontend')} className="group flex items-center gap-3 px-6 py-3 bg-white hover:bg-slate-50 text-slate-600 text-sm font-bold border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all">
                                <span className="bg-pink-100 p-1.5 rounded text-pink-600 group-hover:bg-pink-200 transition-colors"><i data-lucide="layout" className="w-4 h-4"></i></span> Add Frontend
                            </button>
                        </div>
                    </main>

                    <HelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />
                </div>
            );
        }

        function Cell({ cell, onChange, onLangChange, onFilenameChange, onRun, onClear, onDelete }) {
  const isBackend = cell.type === 'backend';
  const isRunning = cell.status === 'running';
  const isCloud = isBackend && cell.language !== 'javascript';
  const borderColor = isRunning ? 'border-indigo-500 ring-2 ring-indigo-500 ring-opacity-20' : 'border-slate-200';

  return (
    <div className={`relative rounded-2xl overflow-hidden border ${borderColor} bg-white shadow-sm transition-all duration-300 hover:shadow-lg group`}>
      <button
        onClick={onDelete}
        className="absolute top-4 right-1 z-10 p-2 bg-white text-red-600 hover:bg-red-50 rounded-full shadow-sm border border-red-100 transition-colors"
        title="Delete Cell"
        aria-label={`Delete cell ${cell.id}`}
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
          <path d="M10 11v6"></path>
          <path d="M14 11v6"></path>
          <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
        </svg>
      </button>

      <div className="px-5 py-3 pr-12 flex items-center justify-between bg-slate-50/50 border-b border-slate-100 backdrop-blur-sm">
        <div className="flex items-center gap-4">
          <div className="flex flex-col">
            <span className={`text-[10px] font-bold px-2.5 py-1 rounded-full tracking-wide border ${isBackend ? 'bg-slate-200/50 text-slate-600 border-slate-300/50' : 'bg-indigo-100/50 text-indigo-600 border-indigo-200/50'}`}>{isBackend ? 'BACKEND' : 'FRONTEND'}</span>
            <span className="text-[10px] text-slate-400 font-mono font-bold mt-1 ml-1">CELL #{cell.id}</span>
          </div>

          <div className="flex items-center gap-2 group/file">
            <i data-lucide="file" className="w-3.5 h-3.5 text-slate-400 group-hover/file:text-indigo-500 transition-colors"></i>
            <input
              type="text"
              value={cell.filename || ''}
              onChange={(e) => onFilenameChange(e.target.value)}
              className="bg-transparent text-xs text-slate-600 font-medium w-40 outline-none focus:text-indigo-600 placeholder:text-slate-300"
              placeholder="filename.ext"
            />
          </div>

          {isBackend && (
            <div className="flex items-center gap-2 border-l border-slate-200 pl-4">
              <select
                value={cell.language || 'javascript'}
                onChange={(e) => onLangChange(e.target.value)}
                className="bg-transparent text-xs text-slate-600 font-bold uppercase tracking-wide outline-none hover:text-indigo-600 cursor-pointer"
              >
                <option value="javascript">Node.js</option>
                <option value="typescript">TypeScript</option>
                <option value="python">Python</option>
                <option value="go">Go</option>
                <option value="rust">Rust</option>
                <option value="java">Java</option>
                <option value="csharp">C#</option>
              </select>
              {isCloud && <span className="text-[9px] text-sky-600 bg-sky-50 px-2 py-0.5 rounded-full border border-sky-100 flex items-center gap-1 font-bold"><i data-lucide="cloud" className="w-2.5 h-2.5"></i> CLOUD</span>}
            </div>
          )}
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={onClear}
            className="p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-lg transition-colors group/clear"
            title="Clear Output"
            aria-label={`Clear output for cell ${cell.id}`}
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4 transition-transform group-hover/clear:rotate-12">
              <path d="M20.84 10.34l-7.17-7.17a2.25 2.25 0 0 0-3.18 0L2.93 10.1a2.25 2.25 0 0 0 0 3.18l7.17 7.17a2.25 2.25 0 0 0 3.18 0l6.65-6.65a2.25 2.25 0 0 0 0-3.16z"></path>
              <path d="M7 13l4-4"></path>
            </svg>
          </button>

          <button
            onClick={onRun}
            disabled={isRunning}
            className={`relative z-30 ml-2 flex items-center gap-2 px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${isRunning ? 'bg-slate-100 text-slate-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700 text-white shadow-md hover:shadow-lg shadow-indigo-200'}`}
          >
            <i data-lucide={isRunning ? "loader-2" : "play"} className={`w-3.5 h-3.5 ${isRunning ? 'animate-spin' : 'fill-current'}`}></i>
            {isRunning ? 'RUNNING' : 'RUN'}
          </button>
        </div>
      </div>

      <div className="flex flex-col md:flex-row h-[400px] md:h-[320px]">
        <div className="flex-1 relative h-full border-r border-slate-100"><Editor code={cell.code} onChange={onChange} language={cell.language || 'javascript'} /></div>
        <div className="flex-1 border-t md:border-t-0 bg-white relative h-full overflow-auto">
          {cell.error && (
            <div className="p-6 bg-red-50 text-red-600 text-sm font-mono whitespace-pre-wrap border-b border-red-100 h-full">
              <div className="flex items-center gap-2 mb-3 font-bold"><i data-lucide="alert-triangle" className="w-5 h-5"></i> Execution Error</div>
              {cell.error}
            </div>
          )}

          {!cell.error && cell.output && (
            <div className="h-full w-full">
              {isBackend ? (
                <div className="p-6 font-mono text-xs text-slate-700 whitespace-pre-wrap leading-relaxed">
                  <div className="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-3 border-b border-slate-100 pb-2">Console Output</div>
                  {JSON.stringify(cell.output, null, 2)}
                </div>
              ) : (
                <div className="preview-box p-6 h-full flex items-center justify-center text-slate-800">{cell.output}</div>
              )}
            </div>
          )}

          {!cell.error && !cell.output && (
            <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-200">
              <i data-lucide="terminal" className="w-12 h-12 mb-3 opacity-40"></i>
              <span className="text-xs font-bold uppercase tracking-widest opacity-60">Ready to Run</span>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

        setTimeout(() => {
            if (window.lucide) window.lucide.createIcons();
        }, 100);
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
